const express = require('express');
const config = require('./src/config');
const passport = require('passport');
const mongoose = require('mongoose');
const bodyParser = require('body-parser');
const path = require('path');
const cors = require('cors');
const session = require('express-session');
const fileUpload = require('express-fileupload');

const authRouter = require('./src/routes/auth_route');
const asnRouter = require('./src/routes/asn_route')
const malwareRouter = require('./src/routes/malware_route');
const contactRouter = require('./src/routes/contact_route');
const notifyRouter = require('./src/routes/notify_route');
const basicAuth = require('./src/routes/basic_auth');
const adminRouter = require('./src/routes/admin_route');
const feedsRouter = require('./src/routes/feeds_route');
const updateStatus = require('./src/controller/cron-job').updateStatusDairy;

const cron = require('node-cron');

cron.schedule('0 0 0 * * *', () => {
  updateStatus();
});

mongoose.Promise = global.Promise;
const mongoDB = 'mongodb://localhost/asninfo';
mongoose.connect(mongoDB, {
  useMongoClient: true
});
const db = mongoose.connection;
db.on('error', console.error.bind(console, 'MongoDB connection error:'));


const app = express();
var corsOptions = {
  origin: '*',
  optionsSuccessStatus: 200,
}
app.use(cors(corsOptions));

app.set('trust proxy', 1) // trust first proxy

app.use(session({
  secret: 'Z7VXZHUWucUAcBWh',
  resave: true,
  saveUninitialized: true,
  cookie: { secure: false, httpOnly: false },
}));

app.use(fileUpload());

app.use(passport.initialize());

app.use(bodyParser.urlencoded({ extended: false }))
app.use(bodyParser.json())

app.set('views', path.join(__dirname, 'src/views'));
app.set('view engine', 'ejs');

app.use('/api/feeds', feedsRouter);
app.use('/api/authentication', authRouter);
app.use('/api/asn', asnRouter);
app.use('/api/malware', malwareRouter);
app.use('/api/admin', adminRouter);
app.use('/api/contact', contactRouter);
app.use('/api/notify', notifyRouter);


app.use(express.static(__dirname + '/src/public'));

const port = config.get('http.port');

var http = require('http');


var server = http.createServer(app);

server.listen(port, () => {
  console.log('Server listening on port http://localhost:' + port);
});

