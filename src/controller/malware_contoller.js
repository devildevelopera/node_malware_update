const Malware = require('../model/malwaresubmit_model');

exports.addNewMalware = async (req, res) => {
    var malwares = req.body;
    var urls = malwares.urls;
    var threats = malwares.threat;
    var tags = malwares.tags;
    var reporter = req.session.user.name;
    var anonymous = malwares.anonymous;

    for (var i = 0; i < urls.length; i++) {
        console.log(urls[i], "    ", tags);

        var prefix = urls[i].substring(0, 5);
        var str1 = '';
        if (prefix == "https") { str1 = urls[i].substring(8); }
        else str1 = urls[i].substring(7);
        var str2 = "http://" + str1;
        var str3 = "https://" + str1;
        console.log("str_test", str2);
        console.log("str_test3", str3);

        var mal2 = await Malware.findOne({ url_ip: str2.trim()});
        console.log('mal2', mal2);
        var mal3 = await Malware.findOne({ url_ip: str3.trim()});
        console.log('mal3', mal3)
        // console.log("duplicate url check: ", mal);

        if (!mal2 && !mal3) {
            var malware = new Malware({
                url_ip: urls[i],
                threat: threats[i],
                tag: tags,
                reporter: reporter,
                anonymous: anonymous
            });
            malware.save()
                .then((malware) => {
                    console.log("submit success");
                    // res.json({ 'success': 'submit malware successfully' });
                    res.status(203).send({ message: 'submit success' });
                })
                .catch((error) => {
                    res.send(error);
                });
        } else {
            console.log("duplicate url");
            res.status(203).send({ message: 'duplicate url' });
        }
    }
}
