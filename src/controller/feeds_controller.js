const ASN = require('../model/asn_model');
const fastcsv = require('fast-csv');
const fs = require('fs');
const path = require('path');
const { Parser } = require('json2csv');

exports.getFeedsByCountry = (req, res) => {
    console.log("here");

    var param = req.params.country.toUpperCase();
    var filepath = path.join(__dirname, '../public/output_csv/outBycountry.csv');
    var ws = fs.createWriteStream(filepath);
    const csvField = ['dataAdded', 'url_ip', 'status', 'threat', , 'ip', 'ASN', 'domain_registrar', 'country'];
    const csvHead = "-----------------------------------------------------------------------------"+"<br>"+
                    "# URLhaus Country CSV Feed                                                   "+"<br>"+
                    "# Generated on      "+ new Date()+                                            +"<br>"+
                    "#                                                                            "+"<br>"+
                    "# For questions please refer to:                                             "+"<br>"+
                    "# https://threathasu.com/feeds/                                              "+"<br>"+
                    "-----------------------------------------------------------------------------"+"<br>"+
                    "#"+"<br>"+
                    "# Feed generated for "+ param+"<br>"+
                    "#"+"<br>"+
                    "# Dateadded (UTC),URL,URL_status,Threat,Host,IPaddress,ASnumber,Country"+"<br>"
    ASN.find({ country: param }, (err, asns) => {
        if (err) {
            console.log(err);
        } else {
            if (asns.length > 0) {
                // var outcsvParser = new Parser({ csvField });
                var outcsv = JSON.parse(JSON.stringify(asns));
                fastcsv.write(outcsv,{headers:csvField}).pipe(ws);
                // res.sendFile(filepath);
                // res.send('ok');

                var resultstr = [];
                for(var asn of asns) {
                    if(asn.status=="online"){
                    resultstr.push(asn.dataAdded);
                    resultstr.push(asn.url_ip);
                    resultstr.push(asn.status);
                    resultstr.push(asn.threat);
                    resultstr.push(asn.domain_registrar);
                    resultstr.push(asn.ip);
                    resultstr.push(asn.ASN);
                    resultstr.push(asn.country+'<br>');
                    }
                }
                res.send(csvHead+resultstr.toString().replace('<br>,','<br>'));
                
            } else {
                res.status(200).send(csvHead+"");
                fastcsv.write([
                    ["a1","b1"],
                    ["b2","c2"],
                    ["c2","g2"]
                ],{headers:true}).pipe(ws);
            }
        }
    })
    
}


exports.getFeedsAll = (req, res) => {
    console.log("here 2");

    var filepath = path.join(__dirname, '../public/output_csv/outforAll.csv');
    var ws = fs.createWriteStream(filepath);
    const csvField = ['dataAdded', 'url_ip', 'status', 'threat', , 'ip', 'ASN', 'domain_registrar', 'country'];
    const csvHead = "-----------------------------------------------------------------------------"+"<br>"+
                    "# URLhaus Country CSV Feed                                                   "+"<br>"+
                    "# Generated on      "+ new Date()+                                            +"<br>"+
                    "#                                                                            "+"<br>"+
                    "# For questions please refer to:                                             "+"<br>"+
                    "# https://threathasu.com/feeds/                                              "+"<br>"+
                    "-----------------------------------------------------------------------------"+"<br>"+
                    "#"+"<br>"+
                    "# Feed generated for All Countries"+"<br>"+
                    "#"+"<br>"+
                    "# Dateadded (UTC),URL,URL_status,Threat,Host,IPaddress,ASnumber,Country"+"<br>"
    ASN.find({}, (err, asns) => {
        if (err) {
            console.log(err);
        } else {
            if (asns.length > 0) {
                // var outcsvParser = new Parser({ csvField });
                var outcsv = JSON.parse(JSON.stringify(asns));
                fastcsv.write(outcsv,{headers:csvField}).pipe(ws);
                // res.sendFile(filepath);
                // res.send('ok');

                var resultstr = [];
                for(var asn of asns) {
                    if(asn.status=="online"){
                    resultstr.push(asn.dataAdded);
                    resultstr.push(asn.url_ip);
                    resultstr.push(asn.status);
                    resultstr.push(asn.threat);
                    resultstr.push(asn.domain_registrar);
                    resultstr.push(asn.ip);
                    resultstr.push(asn.ASN);
                    resultstr.push(asn.country+'<br>');
                    }
                }
                res.send(csvHead+resultstr.toString().replace('<br>,','<br>'));
                
            } else {
                res.status(200).send(csvHead+"");
                fastcsv.write([
                    ["a1","b1"],
                    ["b2","c2"],
                    ["c2","g2"]
                ],{headers:true}).pipe(ws);
            }
        }
    })
}


exports.getFeedsEmpty = (req, res) => {
    res.redirect("https://threathaus.com/feeds");
}

