const passport = require('passport');
const passportTwitter = require('passport-twitter');
const User = require('../model/user');

const passportConfig = {
    consumerKey: 'rp7RaC5ijLb8scLKBEeMuD5EY',
    consumerSecret: 'sdltfOVVcyHA5xRCY8zbKS6DNgQv3cOlLuA8nAgI2PxerogMpU',
    callbackURL: 'https://threathaus.com/api/authentication/twitter/redirect',
};

if (passportConfig.consumerKey) {
    passport.use(new passportTwitter.Strategy(passportConfig, function (accessToken, refreshToken, profile, done) {
        User.findOne({ 'provider': 'twitter', 'uid': profile.id })
            .then((user) => {

                try {
                    if (!user) {
                        User.create({
                            name: profile.username,
                            provider: 'twitter',
                            uid: profile.id,
                            photoUrl: profile.photos[0].value
                        }).then((user) => {
                            return done(null, user)
                        }).catch(e => {
                            return done(e, user)
                        })

                    } else {
                        if (user.name == profile.displayName) {
                            User.findOneAndUpdate({ 'provider': 'twitter', 'uid': profile.id }, { name: profile.username }, {upsert:true}, function(err, user){
                                if (err) {
                                    console.log("can't save user", err)
                                }

                                console.log("succesfully saved", user);
                            });
                        }
                        console.log('user already exists', user.toJSON())
                        return done(null, user);
                    }
                } catch (error) {
                    console.log(error);
                }
            })
    }));

}
