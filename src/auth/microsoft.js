const passport = require('passport');
const passportMicrosoft = require('passport-microsoft');
const config = require('../config');
const User = require('../model/user');

const passportConfig = {
    clientID: '7c8f39c3-12bd-4261-8624-fd02e881847b',
    clientSecret: 'zTPUEN012}mzyiauUA05%~#',
    callbackURL: 'https://localhost/api/authentication/microsoft/redirect',
};

if (passportConfig.clientID) {
    passport.use(new passportMicrosoft.Strategy(passportConfig, function (accessToken, refreshToken, profile, done) {
        User.findOne({ 'provider': 'microsoft', 'uid': profile.id })
            .then((user) => {
                console.log("\n\n\nuser::", profile.photos[0].value)
                try {
                    if (!user) {
                        console.log('user does not exists', user)

                        User.create({
                            name: profile.displayName,
                            provider: 'microsoft',
                            uid: profile.id,
                            photoUrl: profile.photos[0]
                        }).then((user) => {
                            return done(null, user)
                        }).catch(e => {
                            return done(e, user)
                        })

                    } else {
                        console.log('user already exists', user)
                        return done(null, user);
                    }
                } catch (error) {
                    console.log(error);
                }

            });
    }));

}
